<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Text Image Generator with Highlights</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Artifakt+Element&display=swap" rel="stylesheet">

<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root { 
  --panel-bg: #2a2b2d; 
  --panel-fg: #fff; 
  --accent: #10a37f; 
  --dark: #202123; 
}
body { 
  margin: 0; 
  font-family: "Artifakt Element", sans-serif; 
  background: #121212; 
  color: #fff; 
}
.app { 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  padding:12px; 
  padding-bottom:220px; 
}

/* Canvas */
.image-canvas {
  aspect-ratio: 9/16;
  width: 100%;
  max-width: 480px;
  display:flex; 
  justify-content:center; 
  align-items:center;
  text-align:center; 
  background:#000;
  position:relative; 
  overflow:hidden;
}
.text-box {
  position:absolute;
  cursor:text;
  min-width:20px;
  min-height:20px;
  outline:none;
  padding:2px 4px;
  border-radius:4px;
  user-select: text;
}
.text-box.active {
  outline:2px dashed var(--accent);
}
#overlay {
  position:absolute; 
  display:none; 
  left:0; top:0;
  touch-action:none;
  user-select:none;
}

/* Bottom spacer */
.bottom-spacer { height:32px; }

/* Download button (top right) */
.download-container {
  position:fixed;
  top:12px; right:12px;
  z-index:1100;
}
.download-btn, .download-menu button {
  background: var(--accent); 
  color: #fff; 
  padding:10px 16px; 
  border:none; 
  border-radius:8px;
  cursor:pointer; 
  font-size:15px; 
  transition: background .2s;
}
.download-btn:hover, .download-menu button:hover { background:#0d8c6b; }
.download-menu {
  position:absolute; 
  top:50px; right:0;
  background:var(--panel-bg); 
  border-radius:8px; 
  padding:10px; 
  display:none; 
  flex-direction:column; 
  gap:10px; 
  color:var(--panel-fg); 
  box-shadow:0 6px 18px rgba(0,0,0,.4); 
  min-width:200px;
  z-index:1200;
}

/* Toolbar */
.settings-toolbar {
  position:fixed;
  bottom:60px; 
  left:0; 
  right:0;
  display:flex; 
  overflow-x:auto;
  background:#1e1f21;
  padding:8px;
  gap:8px;
  z-index:200;
  box-shadow:0 -2px 8px rgba(0,0,0,.4);
}
.settings-toolbar button {
  flex:0 0 auto;
  background:#2d2d2d;
  border:none;
  padding:8px 12px;
  border-radius:8px;
  color:#fff;
  font-size:14px;
  cursor:pointer;
}
.settings-toolbar button:hover { background:#3a3b3c; }

/* Panels */
.settings-panel {
  position:fixed;
  bottom:110px;
  left:10px;
  right:10px;
  background:var(--panel-bg);
  color:var(--panel-fg);
  border-radius:16px;
  padding:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.5);
  max-height:50vh;
  overflow-y:auto;
  display:none;
  z-index:300;
  animation: slideUp .3s ease;
}
@keyframes slideUp {
  from { transform:translateY(30px); opacity:0; }
  to { transform:translateY(0); opacity:1; }
}
.settings-panel label, 
.settings-panel strong { 
  font-size:14px; 
  margin-bottom:6px; 
  display:flex; 
  align-items:center; 
  gap:8px; 
}
.settings-panel input[type="color"], 
.settings-panel select, 
.settings-panel input[type="file"], 
.settings-panel input[type="range"], 
.settings-panel input[type="number"] {
  flex:1;
  margin-top:4px;
}
.slider-row { 
  display:flex; 
  align-items:center; 
  gap:8px; 
  margin-bottom:10px; 
}
.slider-value { 
  font-size:13px; 
  color:#ddd; 
  min-width:44px; 
  text-align:right; 
}
.highlight-section { 
  border-top:1px solid rgba(255,255,255,0.12); 
  padding-top:8px; 
  margin-top:8px;
}
.highlight-row { 
  display:flex; 
  align-items:center; 
  gap:8px; 
  margin-bottom:6px; 
}
.highlight-row label { 
  flex:1; 
  overflow:hidden; 
  white-space:nowrap; 
  text-overflow:ellipsis; 
  cursor:pointer; 
}
.add-word-input { 
  width:100%; 
  padding:8px; 
  border-radius:6px; 
  border:none; 
  outline:none; 
  background:#3a3b3c; 
  color:#fff; 
}

/* Text panel styling */
.text-panel-section { margin-bottom:12px; }
.text-panel-section label { display:block; margin-bottom:4px; }
.text-panel-buttons { display:flex; gap:6px; margin-top:4px; flex-wrap:wrap; }
.text-panel-buttons button { padding:4px 8px; font-size:14px; cursor:pointer; border-radius:4px; border:none; background:#2d2d2d; color:#fff; }
.text-panel-buttons button.active { background:var(--accent); }
</style>
</head>
<body>
<div class="app">
  <div id="canvas" class="image-canvas" aria-label="preview canvas">
    <img id="overlay">
  </div>
  <div class="bottom-spacer"></div>
</div>

<!-- Download -->
<div class="download-container">
  <button id="downloadBtn" class="download-btn">Download</button>
  <div id="downloadMenu" class="download-menu">
    <button data-scale="1" data-quality="low">Low Quality</button>
    <button data-scale="2" data-quality="medium">Medium Quality</button>
    <button data-scale="4" data-quality="high">High Quality</button>
  </div>
</div>

<!-- Settings toolbar -->
<div class="settings-toolbar">
  <button data-panel="textPanel">Text</button>
  <button data-panel="overlayPanel">Overlay</button>
  <button data-panel="highlightPanel">Highlights</button>
</div>

<!-- Panels -->
<div id="textPanel" class="settings-panel">
  <div class="text-panel-section">
    <strong>Text Selection</strong>
    <select id="textSelect"></select>
  </div>

  <div class="text-panel-section">
    <strong>Edit Text</strong>
    <textarea id="textEdit" rows="3" style="width:100%; background:#2d2d2d; color:#fff; border-radius:6px; border:none; padding:6px;"></textarea>
  </div>

  <div class="text-panel-section text-panel-buttons">
    <button id="deleteText">üóë Delete</button>
    <button id="copyText">üìÑ Copy</button>
  </div>

  <div class="text-panel-section">
    <strong>Text Position</strong>
    <div class="slider-row">
      <label>X: <input type="range" id="posX" min="0" max="480"><span id="posXVal">0</span>px</label>
    </div>
    <div class="slider-row">
      <label>Y: <input type="range" id="posY" min="0" max="853"><span id="posYVal">0</span>px</label>
    </div>
    <div class="text-panel-buttons">
      <button data-move="-1px" data-dir="x">‚¨ÖÔ∏è</button>
      <button data-move="1px" data-dir="x">‚û°Ô∏è</button>
      <button data-move="-1px" data-dir="y">‚¨ÜÔ∏è</button>
      <button data-move="1px" data-dir="y">‚¨áÔ∏è</button>
      <button data-align="top">Top</button>
      <button data-align="bottom">Bottom</button>
      <button data-align="left">Left</button>
      <button data-align="right">Right</button>
      <button data-align="center">Center</button>
    </div>
  </div>

  <div class="text-panel-section">
    <strong>Font Color</strong>
    <input type="color" id="fontColorPicker" value="#ececf1">
    <input type="number" id="fontOpacity" min="0" max="100" value="100">%
  </div>

  <div class="text-panel-section">
    <strong>Font Size</strong>
    <input type="range" id="fontSizeSlider" min="2" max="500" value="15">
    <span id="fontSizeVal">15px</span>
    <div class="text-panel-buttons">
      <button data-size="-1">-</button>
      <button data-size="1">+</button>
    </div>
  </div>

  <div class="text-panel-section">
    <strong>Font Selection / Upload</strong>
    <select id="fontSelect">
      <option value="Artifakt Element">Artifakt Element</option>
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Times New Roman">Times New Roman</option>
    </select>
    <input type="file" id="fontUpload" accept=".ttf,.otf,.woff,.woff2">
  </div>

  <div class="text-panel-section text-panel-buttons">
    <button data-style="bold">B</button>
    <button data-style="italic">I</button>
    <button data-style="underline">U</button>
    <button data-style="line-through">S</button>
  </div>

  <div class="text-panel-section text-panel-buttons">
    <button data-align-text="left">Left</button>
    <button data-align-text="center">Center</button>
    <button data-align-text="right">Right</button>
    <button data-align-text="justify">Justify</button>
  </div>

  <div class="text-panel-section">
    <strong>Line Spacing</strong>
    <input type="range" id="lineSpacing" min="0.5" max="3" step="0.1" value="1.4">
    <span id="lineSpacingVal">1.4</span>
    <div class="text-panel-buttons">
      <button data-line="-0.1">-</button>
      <button data-line="0.1">+</button>
    </div>
  </div>

  <div class="text-panel-section">
    <strong>Letter Spacing</strong>
    <input type="range" id="letterSpacing" min="0" max="5" step="0.1" value="0">
    <span id="letterSpacingVal">0</span>
    <div class="text-panel-buttons">
      <button data-letter="-0.1">-</button>
      <button data-letter="0.1">+</button>
    </div>
  </div>
</div>

<!-- Overlay Panel -->
<div id="overlayPanel" class="settings-panel">
  <label>Upload Overlay Image: <input id="overlayUpload" type="file" accept="image/*" /></label>
  <div class="slider-row">
    <label style="flex:1">Overlay Size:
      <input id="overlaySize" type="range" min="50" max="1000" value="200" />
    </label>
    <div id="overlaySizeVal" class="slider-value">200px</div>
  </div>
</div>

<!-- Highlights Panel -->
<div id="highlightPanel" class="settings-panel">
  <div class="highlight-section">
    <strong>Highlight Words</strong>
    <div><input id="selectAllWords" type="checkbox" /> <label for="selectAllWords">Select All / Unselect All</label></div>
    <div id="highlightWordsContainer"></div>
    <input id="addWordInput" class="add-word-input" placeholder="Add custom word and press Enter" />
  </div>
</div>

<script>
/***************
  Elements
****************/
const canvas = document.getElementById('canvas');
const panels = document.querySelectorAll('.settings-panel');
const toolbarButtons = document.querySelectorAll('.settings-toolbar button');
const overlay = document.getElementById('overlay');
const overlayUpload = document.getElementById('overlayUpload');
const overlaySizeInput = document.getElementById('overlaySize');
const overlaySizeVal = document.getElementById('overlaySizeVal');

const highlightContainer = document.getElementById('highlightWordsContainer');
const addWordInput = document.getElementById('addWordInput');
const selectAllCheckbox = document.getElementById('selectAllWords');

const downloadBtn = document.getElementById('downloadBtn');
const downloadMenu = document.getElementById('downloadMenu');

// Text Panel elements
const textSelect = document.getElementById('textSelect');
const textEdit = document.getElementById('textEdit');
const deleteText = document.getElementById('deleteText');
const copyText = document.getElementById('copyText');
const posX = document.getElementById('posX');
const posY = document.getElementById('posY');
const posXVal = document.getElementById('posXVal');
const posYVal = document.getElementById('posYVal');
const fontColorPicker = document.getElementById('fontColorPicker');
const fontOpacity = document.getElementById('fontOpacity');
const fontSizeSlider = document.getElementById('fontSizeSlider');
const fontSizeVal = document.getElementById('fontSizeVal');
const fontSelect = document.getElementById('fontSelect');
const fontUpload = document.getElementById('fontUpload');
const styleButtons = document.querySelectorAll('[data-style]');
const alignButtons = document.querySelectorAll('[data-align-text]');
const lineSpacing = document.getElementById('lineSpacing');
const lineSpacingVal = document.getElementById('lineSpacingVal');
const lineButtons = document.querySelectorAll('[data-line]');
const letterSpacing = document.getElementById('letterSpacing');
const letterSpacingVal = document.getElementById('letterSpacingVal');
const letterButtons = document.querySelectorAll('[data-letter]');
const moveButtons = document.querySelectorAll('[data-move]');
const alignRelButtons = document.querySelectorAll('[data-align]');

let textBoxes = [];
let activeText = null;

// Toolbar toggle
toolbarButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const target = document.getElementById(btn.dataset.panel);
    const isOpen = target.style.display === 'block';
    panels.forEach(p => p.style.display = 'none');
    if (!isOpen) target.style.display = 'block';
  });
});
document.addEventListener('pointerdown', (e) => {
  if (![...panels].some(p => p.contains(e.target)) && 
      ![...toolbarButtons].some(b => b.contains(e.target))) {
    panels.forEach(p => p.style.display = 'none');
  }
});

/********************
 Text Box Functions
*********************/
function createTextBox(text="New Text") {
  const div = document.createElement('div');
  div.className = 'text-box';
  div.contentEditable = true;
  div.innerText = text;
  div.style.left = '40px';
  div.style.top = '40px';
  div.style.fontSize = '15px';
  div.style.color = '#ececf1';
  div.style.fontFamily = 'Artifakt Element';
  div.style.lineHeight = '1.4';
  div.style.letterSpacing = '0px';
  canvas.appendChild(div);

  div.addEventListener('click', e=>{
    setActiveText(div);
    e.stopPropagation();
  });

  // Drag support
  let dragging=false, startX=0, startY=0, startLeft=0, startTop=0;
  div.addEventListener('pointerdown', e=>{
    dragging=true;
    startX=e.clientX;
    startY=e.clientY;
    startLeft=parseFloat(div.style.left);
    startTop=parseFloat(div.style.top);
    div.setPointerCapture(e.pointerId);
    setActiveText(div);
    e.stopPropagation();
  });
  div.addEventListener('pointermove', e=>{
    if(!dragging) return;
    div.style.left=(startLeft+e.clientX-startX)+'px';
    div.style.top=(startTop+e.clientY-startY)+'px';
    updatePanelValues();
  });
  div.addEventListener('pointerup', e=>{
    dragging=false;
    div.releasePointerCapture(e.pointerId);
  });

  textBoxes.push(div);
  updateTextSelect();
  setActiveText(div);
}

// --- Rest of JS remains mostly same but fixes applied for px parsing, highlights, font upload, etc ---

  function setActiveText(box) {
  if(activeText) activeText.classList.remove('active');
  activeText = box;
  if(activeText) activeText.classList.add('active');
  updatePanelValues();
}

function updateTextSelect(){
  textSelect.innerHTML = "";
  textBoxes.forEach((box, idx)=>{
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = box.innerText.slice(0,20) || 'Text '+(idx+1);
    textSelect.appendChild(opt);
  });
  if(activeText) textSelect.value = textBoxes.indexOf(activeText);
}

function updatePanelValues(){
  if(!activeText) return;
  textEdit.value = activeText.innerText;
  posX.value = parseInt(activeText.style.left);
  posY.value = parseInt(activeText.style.top);
  posXVal.textContent = posX.value;
  posYVal.textContent = posY.value;
  fontColorPicker.value = rgbToHex(activeText.style.color);
  fontOpacity.value = Math.round(parseFloat(getComputedStyle(activeText).opacity)*100);
  fontSizeSlider.value = parseInt(activeText.style.fontSize);
  fontSizeVal.textContent = fontSizeSlider.value+'px';
  fontSelect.value = activeText.style.fontFamily;
  lineSpacing.value = parseFloat(activeText.style.lineHeight);
  lineSpacingVal.textContent = lineSpacing.value;
  letterSpacing.value = parseFloat(activeText.style.letterSpacing);
  letterSpacingVal.textContent = letterSpacing.value;
  styleButtons.forEach(btn=>{
    const s = btn.dataset.style;
    btn.classList.toggle('active', 
      (s==='bold' && activeText.style.fontWeight==='bold') ||
      (s==='italic' && activeText.style.fontStyle==='italic') ||
      (s==='underline' && activeText.style.textDecoration.includes('underline')) ||
      (s==='line-through' && activeText.style.textDecoration.includes('line-through'))
    );
  });
}

// Text Panel Events
textSelect.addEventListener('change', ()=> setActiveText(textBoxes[textSelect.value]));
textEdit.addEventListener('input', ()=> { if(activeText) { activeText.innerText=textEdit.value; updateTextSelect(); updateDetectedWords(); } });

deleteText.addEventListener('click', ()=>{ 
  if(activeText){ 
    canvas.removeChild(activeText); 
    textBoxes = textBoxes.filter(t=>t!==activeText); 
    activeText = textBoxes[0] || null;
    updateTextSelect();
    updatePanelValues();
  }
});

copyText.addEventListener('click', ()=>{
  if(activeText){
    const copy = createTextBox(activeText.innerText);
    const box = textBoxes[textBoxes.length-1];
    box.style.left = (parseInt(activeText.style.left)+10)+'px';
    box.style.top = (parseInt(activeText.style.top)+10)+'px';
    ['fontSize','fontFamily','color','fontWeight','fontStyle','textDecoration','lineHeight','letterSpacing'].forEach(prop=>{
      box.style[prop] = activeText.style[prop];
    });
    setActiveText(box);
  }
});

posX.addEventListener('input', ()=>{ if(activeText){ activeText.style.left = posX.value+'px'; posXVal.textContent = posX.value; } });
posY.addEventListener('input', ()=>{ if(activeText){ activeText.style.top = posY.value+'px'; posYVal.textContent = posY.value; } });
fontColorPicker.addEventListener('input', ()=>{ if(activeText) activeText.style.color=fontColorPicker.value; });
fontOpacity.addEventListener('input', ()=>{ if(activeText) activeText.style.opacity=(fontOpacity.value/100); });
fontSizeSlider.addEventListener('input', ()=>{ if(activeText){ activeText.style.fontSize=fontSizeSlider.value+'px'; fontSizeVal.textContent=fontSizeSlider.value+'px'; } });
fontSelect.addEventListener('change', ()=>{ if(activeText) activeText.style.fontFamily=fontSelect.value; });

fontUpload.addEventListener('change', e=>{
  const f=e.target.files[0];
  if(f && activeText){
    const url=URL.createObjectURL(f); 
    const font=new FontFace(f.name.replace(/\s+/g,'_'),url); 
    font.load().then(ff=>{document.fonts.add(ff); activeText.style.fontFamily=f.name.replace(/\s+/g,'_'); fontSelect.value=activeText.style.fontFamily;});
  }
});

styleButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!activeText) return;
    const s = btn.dataset.style;
    if(s==='bold') activeText.style.fontWeight = (activeText.style.fontWeight==='bold')?'normal':'bold';
    if(s==='italic') activeText.style.fontStyle = (activeText.style.fontStyle==='italic')?'normal':'italic';
    if(s==='underline') activeText.style.textDecoration = (activeText.style.textDecoration.includes('underline'))?'none':'underline';
    if(s==='line-through') activeText.style.textDecoration = (activeText.style.textDecoration.includes('line-through'))?'none':'line-through';
    btn.classList.toggle('active');
  });
});

alignButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{ if(!activeText) return; activeText.style.textAlign = btn.dataset.alignText; });
});

lineSpacing.addEventListener('input', ()=>{ if(activeText){ activeText.style.lineHeight=lineSpacing.value; lineSpacingVal.textContent=lineSpacing.value; } });
lineButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{ 
    if(!activeText) return; 
    activeText.style.lineHeight=(parseFloat(activeText.style.lineHeight)+parseFloat(btn.dataset.line)).toFixed(2); 
    lineSpacing.value = parseFloat(activeText.style.lineHeight); 
    lineSpacingVal.textContent=lineSpacing.value; 
  });
});

letterSpacing.addEventListener('input', ()=>{ if(activeText){ activeText.style.letterSpacing=letterSpacing.value+'px'; letterSpacingVal.textContent=letterSpacing.value; } });
letterButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!activeText) return; 
    let newLetter = (parseFloat(activeText.style.letterSpacing)+parseFloat(btn.dataset.letter)).toFixed(1);
    activeText.style.letterSpacing=newLetter+'px'; 
    letterSpacing.value=parseFloat(newLetter); 
    letterSpacingVal.textContent=letterSpacing.value;
  });
});

moveButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!activeText) return;
    const val = parseInt(btn.dataset.move);
    if(btn.dataset.dir==='x') activeText.style.left=(parseInt(activeText.style.left)+val)+'px';
    else activeText.style.top=(parseInt(activeText.style.top)+val)+'px';
    updatePanelValues();
  });
});

alignRelButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(!activeText) return;
    const a = btn.dataset.align;
    if(a==='top') activeText.style.top='0px';
    if(a==='bottom') activeText.style.top=(canvas.clientHeight-activeText.offsetHeight)+'px';
    if(a==='left') activeText.style.left='0px';
    if(a==='right') activeText.style.left=(canvas.clientWidth-activeText.offsetWidth)+'px';
    if(a==='center'){
      activeText.style.left=((canvas.clientWidth-activeText.offsetWidth)/2)+'px';
      activeText.style.top=((canvas.clientHeight-activeText.offsetHeight)/2)+'px';
    }
    updatePanelValues();
  });
});

/********************
 Overlay
*********************/
let overlayX=40, overlayY=40, dragging=false, startX=0, startY=0, startOverlayX=0, startOverlayY=0;
let startDistance=0, startScale=1, currentScale=1;

overlayUpload.addEventListener('change', e=>{
  const f=e.target.files[0];
  if(f){ 
    const r=new FileReader(); 
    r.onload=ev=>{
      overlay.src=ev.target.result; 
      overlay.style.display='block'; 
      overlay.style.left=overlayX+'px'; 
      overlay.style.top=overlayY+'px'; 
      overlay.width=overlaySizeInput.value; 
      overlay.style.transform=`scale(${currentScale})`;
    }; 
    r.readAsDataURL(f);
  }
});
overlaySizeInput.addEventListener('input', ()=>{
  overlay.width=overlaySizeInput.value; 
  overlaySizeVal.textContent=overlaySizeInput.value+"px";
});

overlay.addEventListener('pointerdown', e=>{
  dragging=true; startX=e.clientX; startY=e.clientY; startOverlayX=overlayX; startOverlayY=overlayY; overlay.setPointerCapture(e.pointerId);
});
overlay.addEventListener('pointermove', e=>{
  if(!dragging) return; 
  const dx=e.clientX-startX, dy=e.clientY-startY; 
  overlayX=startOverlayX+dx; 
  overlayY=startOverlayY+dy; 
  overlay.style.left=overlayX+'px'; overlay.style.top=overlayY+'px';
});
overlay.addEventListener('pointerup', e=>{ dragging=false; overlay.releasePointerCapture(e.pointerId); });

// pinch zoom
overlay.addEventListener('touchstart', e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dx=e.touches[0].clientX - e.touches[1].clientX;
    const dy=e.touches[0].clientY - e.touches[1].clientY;
    startDistance = Math.sqrt(dx*dx+dy*dy);
    startScale = currentScale;
  }
}, {passive:false});
overlay.addEventListener('touchmove', e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dx=e.touches[0].clientX - e.touches[1].clientX;
    const dy=e.touches[0].clientY - e.touches[1].clientY;
    const newDist = Math.sqrt(dx*dx+dy*dy);
    const scale = newDist / startDistance;
    currentScale = Math.max(0.2, Math.min(5, startScale * scale));
    overlay.style.transform = `scale(${currentScale})`;
    overlaySizeInput.value = Math.round(overlay.naturalWidth * currentScale);
    overlaySizeVal.textContent = overlaySizeInput.value + "px";
  }
}, {passive:false});

/********************
 Highlights
*********************/
let detectedWords = [], customWords = [], highlightedWords = {};
const stopWords = ["the","is","a","an","and","or","in","on","at","of","for","to","with","by","you","your","this","that","it","as","be","are","was","were","from","into","but","if","so","about","can","not","i","me","my","myself","we","our","ours","he","him","his","himself","she","her","hers","herself","they","them","their","theirs","themselves","what","which","who","whom","these","those","am","been","being","have","has","had","having","do","does","did","doing","because","until","while","against","between","through","during","before","after","above","below","up","down","out","off","over","under","again","further","then","once","here","there","when","where","why","all","any","both","each","few","more","most","other","some","such","no","nor","only","own","same","than","too","very"];

function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

function updateHighlightedText(){
  textBoxes.forEach(tb=>{
    let txt = tb.innerText || "";
    const allOrder = Array.from(new Set([...detectedWords, ...customWords]));
    allOrder.forEach(w => {
      if (highlightedWords[w]) {
        const regex = new RegExp("\\b(" + escapeRegex(w) + ")\\b", "gi");
        txt = txt.replace(regex, '<span style="font-weight:bold;">$1</span>');
      }
    });
    tb.innerHTML = txt.replace(/\n/g, "<br/>");
  });
}

function updateDetectedWords(){
  textBoxes.forEach(tb=>{
    const content = (tb.innerText || "").toLowerCase().replace(/[.,!?;:()"]/g,"");
    const arr = content.split(/\s+/).filter(w => w && !stopWords.includes(w));
    const freq = {};
    arr.forEach(w => freq[w] = (freq[w]||0)+1);
    detectedWords = Object.keys(freq).sort((a,b)=> (freq[b]-freq[a]) || (b.length - a.length)).slice(0,8);
    detectedWords.forEach(w => { if (!(w in highlightedWords)) highlightedWords[w] = true; });
    renderHighlightWords();
  });
}

function renderHighlightWords(){
  highlightContainer.innerHTML = "";
  const all = Array.from(new Set([...detectedWords, ...customWords]));
  all.forEach((word, idx) => {
    const id = 'cb_'+idx+'_'+word.replace(/[^a-z0-9]/gi,'_')+'_'+Math.random().toString(36).slice(2,7);
    const row = document.createElement('div');
    row.className = 'highlight-row';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = id;
    cb.checked = !!highlightedWords[word];
    cb.addEventListener('change', () => {
      highlightedWords[word] = cb.checked;
      updateHighlightedText();
      selectAllCheckbox.checked = all.every(w => highlightedWords[w]);
    });

    const lbl = document.createElement('label');
    lbl.htmlFor = id;
    lbl.textContent = word;

    row.appendChild(cb);
    row.appendChild(lbl);
    highlightContainer.appendChild(row);
  });
  updateHighlightedText();
  selectAllCheckbox.checked = all.every(w => highlightedWords[w]);
}

addWordInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    const w = e.target.value.toLowerCase().trim();
    if (w && !customWords.includes(w)) {
      customWords.push(w);
      highlightedWords[w] = true;
      renderHighlightWords();
    }
    e.target.value = "";
  }
});

selectAllCheckbox.addEventListener('change', () => {
  const all = Array.from(new Set([...detectedWords, ...customWords]));
  all.forEach(w => highlightedWords[w] = selectAllCheckbox.checked);
  renderHighlightWords();
});

/********************
 Download
*********************/
downloadBtn.addEventListener('click', ()=> downloadMenu.style.display = downloadMenu.style.display==='flex'?'none':'flex');
downloadMenu.querySelectorAll('button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const scale = parseInt(btn.dataset.scale);
    html2canvas(canvas,{scale}).then(canvasOut=>{
      const link=document.createElement('a');
      link.download='text_image.png';
      link.href=canvasOut.toDataURL();
      link.click();
    });
    downloadMenu.style.display='none';
  });
});

/********************
 Helpers
*********************/
function rgbToHex(rgb){
  if(!rgb) return "#ffffff";
  const res = rgb.match(/\d+/g);
  if(!res) return "#ffffff";
  return "#"+((1<<24)+(parseInt(res[0])<<16)+(parseInt(res[1])<<8)+parseInt(res[2])).toString(16).slice(1);
}

/********************
 Initialize
*********************/
createTextBox("Hello World");
updateDetectedWords();
updateHighlightedText();

