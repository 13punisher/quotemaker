<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Text Image Generator with Highlights</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Artifakt+Element&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root { 
      --panel-bg: #2a2b2d; 
      --panel-fg: #fff; 
      --accent: #10a37f; 
      --dark: #202123; 
    }
    body { 
      margin: 0; 
      font-family: "Artifakt Element", sans-serif; 
      background: #121212; 
      color: #fff; 
    }
    .app { 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      padding:12px; 
      padding-bottom:220px; 
    }

    /* Canvas */
    .image-canvas {
      aspect-ratio: 9/16;
      width: 100%;
      max-width: 480px;
      display:flex; 
      justify-content:center; 
      align-items:center;
      text-align:center; 
      background:#000;
      position:relative; 
      overflow:hidden;
    }
    .editable-text { 
      max-width:85%; 
      word-wrap:break-word; 
      white-space:pre-wrap; 
      color:#ececf1; 
      font-size:15px; 
      line-height:1.4; 
      text-align:left; 
    }

    .bottom-spacer { height:32px; }

    /* Download button (top right) */
    .download-container {
      position:fixed;
      top:12px; right:12px;
      z-index:1100;
    }
    .download-btn, .download-menu button {
      background: var(--accent); 
      color: #fff; 
      padding:10px 16px; 
      border:none; 
      border-radius:8px;
      cursor:pointer; 
      font-size:15px; 
      transition: background .2s;
    }
    .download-btn:hover, .download-menu button:hover { background:#0d8c6b; }
    .download-menu {
      position:absolute; 
      top:50px; right:0;
      background:var(--panel-bg); 
      border-radius:8px; 
      padding:10px; 
      display:none; 
      flex-direction:column; 
      gap:10px; 
      color:var(--panel-fg); 
      box-shadow:0 6px 18px rgba(0,0,0,.4); 
      min-width:200px;
      z-index:1200;
    }

    /* Chat input */
    .chat-input-bar {
      position:fixed; 
      bottom:0; left:0; right:0;
      display:flex; 
      align-items:flex-end; 
      justify-content:space-between;
      background:var(--dark); 
      padding:10px 12px; 
      border-top:1px solid #444;
      gap:10px; 
      z-index:100; 
      box-shadow:0 -2px 8px rgba(0,0,0,.25);
    }
    .chat-textarea {
      flex:1; 
      max-height:180px; 
      min-height:40px;
      resize:none; 
      background:#2d2d2d; 
      color:#fff; 
      border:none; 
      border-radius:16px; 
      padding:10px 14px; 
      font-size:15px; 
      outline:none;
    }

    /* Toolbar */
    .settings-toolbar {
      position:fixed;
      bottom:60px; 
      left:0; 
      right:0;
      display:flex; 
      overflow-x:auto;
      background:#1e1f21;
      padding:8px;
      gap:8px;
      z-index:200;
      box-shadow:0 -2px 8px rgba(0,0,0,.4);
    }
    .settings-toolbar button {
      flex:0 0 auto;
      background:#2d2d2d;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      color:#fff;
      font-size:14px;
      cursor:pointer;
    }
    .settings-toolbar button:hover {
      background:#3a3b3c;
    }

    /* Panels */
    .settings-panel {
      position:fixed;
      bottom:110px;
      left:10px;
      right:10px;
      background:var(--panel-bg);
      color:var(--panel-fg);
      border-radius:16px;
      padding:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.5);
      max-height:50vh;
      overflow-y:auto;
      display:none;
      z-index:300;
      animation: slideUp .3s ease;
    }
    @keyframes slideUp {
      from { transform:translateY(30px); opacity:0; }
      to { transform:translateY(0); opacity:1; }
    }

    .settings-panel label, 
    .settings-panel strong { 
      font-size:14px; 
      margin-bottom:6px; 
      display:flex; 
      align-items:center; 
      gap:8px; 
    }
    .settings-panel input[type="color"], 
    .settings-panel select, 
    .settings-panel input[type="file"], 
    .settings-panel input[type="range"] {
      flex:1;
      margin-top:4px;
    }

    .slider-row { 
      display:flex; 
      align-items:center; 
      gap:8px; 
      margin-bottom:10px;
    }
    .slider-value { 
      font-size:13px; 
      color:#ddd; 
      min-width:44px; 
      text-align:right; 
    }

    .highlight-section { 
      border-top:1px solid rgba(255,255,255,0.12); 
      padding-top:8px; 
      margin-top:8px;
    }
    .highlight-row { 
      display:flex; 
      align-items:center; 
      gap:8px; 
      margin-bottom:6px; 
    }
    .highlight-row label { 
      flex:1; 
      overflow:hidden; 
      white-space:nowrap; 
      text-overflow:ellipsis; 
      cursor:pointer; 
    }

    .add-word-input { 
      width:100%; 
      padding:8px; 
      border-radius:6px; 
      border:none; 
      outline:none; 
      background:#3a3b3c; 
      color:#fff; 
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="canvas" class="image-canvas" aria-label="preview canvas">
      <div id="editable-text" class="editable-text" contenteditable="false"></div>
      <img id="overlay" style="display:none; position:absolute; cursor:grab; touch-action:none;" draggable="false" />
    </div>
    <div class="bottom-spacer"></div>
  </div>

  <!-- Download -->
  <div class="download-container">
    <button id="downloadBtn" class="download-btn">Download</button>
    <div id="downloadMenu" class="download-menu">
      <button data-scale="1" data-quality="low">Low Quality</button>
      <button data-scale="2" data-quality="medium">Medium Quality</button>
      <button data-scale="4" data-quality="high">High Quality</button>
    </div>
  </div>

  <!-- Settings toolbar -->
  <div class="settings-toolbar">
    <button data-panel="fontColorPanel">Font Color</button>
    <button data-panel="overlayPanel">Overlay</button>
    <button data-panel="highlightPanel">Highlights</button>
  </div>

  <!-- Panels -->
  <div id="fontColorPanel" class="settings-panel">
    <label>Font Color: <input id="fontColor" type="color" value="#ececf1" /></label>
  </div>
  <div id="overlayPanel" class="settings-panel">
    <label>Upload Overlay Image: <input id="overlayUpload" type="file" accept="image/*" /></label>
    <div class="slider-row">
      <label style="flex:1">Overlay Size:
        <input id="overlaySize" type="range" min="50" max="1000" value="200" />
      </label>
      <div id="overlaySizeVal" class="slider-value">200px</div>
    </div>
  </div>
  <div id="highlightPanel" class="settings-panel">
    <div class="highlight-section">
      <strong>Highlight Words</strong>
      <div><input id="selectAllWords" type="checkbox" /> <label for="selectAllWords">Select All / Unselect All</label></div>
      <div id="highlightWordsContainer"></div>
      <input id="addWordInput" class="add-word-input" placeholder="Add custom word and press Enter" />
    </div>
  </div>

  <!-- Chat input -->
  <div class="chat-input-bar" role="region" aria-label="controls">
    <textarea id="textInput" class="chat-textarea" placeholder="Type your text here"></textarea>
  </div>

  <script>
    /***********************
      Elements
    ***********************/
    const canvas = document.getElementById('canvas');
    const textEl = document.getElementById('editable-text');
    const textInput = document.getElementById('textInput');
    const overlay = document.getElementById('overlay');

    const fontColorInput = document.getElementById('fontColor');
    const overlayUpload = document.getElementById('overlayUpload');
    const overlaySizeInput = document.getElementById('overlaySize');
    const overlaySizeVal = document.getElementById('overlaySizeVal');

    const highlightContainer = document.getElementById('highlightWordsContainer');
    const addWordInput = document.getElementById('addWordInput');
    const selectAllCheckbox = document.getElementById('selectAllWords');

    const downloadBtn = document.getElementById('downloadBtn');
    const downloadMenu = document.getElementById('downloadMenu');

    let overlayX = 40, overlayY = 40;
    let dragging = false, startX = 0, startY = 0, startOverlayX = 0, startOverlayY = 0;

    let startDistance = 0;
    let startScale = 1;
    let currentScale = 1;

    let detectedWords = [], customWords = [], highlightedWords = {};

    const stopWords = ["the","is","a","an","and","or","in","on","at","of","for","to","with","by","you","your","this","that","it","as","be","are","was","were","from","into","but","if","so","about","can","not","i","me","my","myself","we","our","ours","ourselves","he","him","his","himself","she","her","hers","herself","they","them","their","theirs","themselves","what","which","who","whom","these","those","am","been","being","have","has","had","having","do","does","did","doing","because","until","while","against","between","through","during","before","after","above","below","up","down","out","off","over","under","again","further","then","once","here","there","when","where","why","all","any","both","each","few","more","most","other","some","such","no","nor","only","own","same","than","too","very"];

    /***********************
      Toolbar Panels
    ***********************/
    const toolbarButtons = document.querySelectorAll('.settings-toolbar button');
    const panels = document.querySelectorAll('.settings-panel');

    toolbarButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const target = document.getElementById(btn.dataset.panel);
        const isOpen = target.style.display === 'block';
        panels.forEach(p => p.style.display = 'none');
        if (!isOpen) target.style.display = 'block';
      });
    });

    document.addEventListener('pointerdown', (e) => {
      if (![...panels].some(p => p.contains(e.target)) && 
          ![...toolbarButtons].some(b => b.contains(e.target))) {
        panels.forEach(p => p.style.display = 'none');
      }
    });

    /***********************
      Highlight functions
    ***********************/
    function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

    function updateHighlightedText(){
      let txt = textInput.value || "";
      const allOrder = Array.from(new Set([...detectedWords, ...customWords]));
      allOrder.forEach(w => {
        if (highlightedWords[w]) {
          const regex = new RegExp("\\b(" + escapeRegex(w) + ")\\b", "gi");
          txt = txt.replace(regex, '<span style="font-weight:bold;">$1</span>');
        }
      });
      textEl.innerHTML = txt.replace(/\n/g, "<br/>");
    }

    function updateDetectedWords(){
      const content = (textInput.value || "").toLowerCase().replace(/[.,!?;:()"]/g,"");
      const arr = content.split(/\s+/).filter(w => w && !stopWords.includes(w));
      const freq = {};
      arr.forEach(w => freq[w] = (freq[w]||0)+1);
      detectedWords = Object.keys(freq).sort((a,b)=> (freq[b]-freq[a]) || (b.length - a.length)).slice(0,8);
      detectedWords.forEach(w => { if (!(w in highlightedWords)) highlightedWords[w] = true; });
      renderHighlightWords();
    }

    function renderHighlightWords(){
      highlightContainer.innerHTML = "";
      const all = Array.from(new Set([...detectedWords, ...customWords]));
      all.forEach((word, idx) => {
        const id = 'cb_'+idx+'_'+word.replace(/[^a-z0-9]/gi,'_')+'_'+Math.random().toString(36).slice(2,7);
        const row = document.createElement('div');
        row.className = 'highlight-row';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.checked = !!highlightedWords[word];
        cb.addEventListener('change', () => {
          highlightedWords[word] = cb.checked;
          updateHighlightedText();
          selectAllCheckbox.checked = all.every(w => highlightedWords[w]);
        });

        const lbl = document.createElement('label');
        lbl.htmlFor = id;
        lbl.textContent = word;

        row.appendChild(cb);
        row.appendChild(lbl);
        highlightContainer.appendChild(row);
      });
      updateHighlightedText();
      selectAllCheckbox.checked = all.every(w => highlightedWords[w]);
    }

    /***********************
      Event Bindings
    ***********************/
    textInput.addEventListener('input', () => {
      updateDetectedWords();
      updateHighlightedText();
    });

    addWordInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const w = e.target.value.toLowerCase().trim();
        if (w && !customWords.includes(w)) {
          customWords.push(w);
          highlightedWords[w] = true;
          renderHighlightWords();
        }
        e.target.value = "";
      }
    });

    selectAllCheckbox.addEventListener('change', () => {
      const all = Array.from(new Set([...detectedWords, ...customWords]));
      all.forEach(w => highlightedWords[w] = selectAllCheckbox.checked);
      renderHighlightWords();
    });

    fontColorInput.addEventListener('input', ()=> textEl.style.color = fontColorInput.value);

    overlayUpload.addEventListener('change', e=>{
      const f=e.target.files[0];
      if(f){ const r=new FileReader(); r.onload=ev=>{
        overlay.src=ev.target.result;
        overlay.style.display='block';
        overlay.style.left=overlayX+'px';
        overlay.style.top=overlayY+'px';
        overlay.width=overlaySizeInput.value;
        overlay.style.transform=`scale(${currentScale})`;
      }; r.readAsDataURL(f);}
    });
    overlaySizeInput.addEventListener('input', ()=>{overlay.width=overlaySizeInput.value; overlaySizeVal.textContent=overlaySizeInput.value+"px";});

    overlay.addEventListener('pointerdown', e=>{dragging=true; startX=e.clientX; startY=e.clientY; startOverlayX=overlayX; startOverlayY=overlayY; overlay.setPointerCapture(e.pointerId);});
    overlay.addEventListener('pointermove', e=>{ if(!dragging)return; const dx=e.clientX-startX, dy=e.clientY-startY; overlayX=startOverlayX+dx; overlayY=startOverlayY+dy; overlay.style.left=overlayX+'px'; overlay.style.top=overlayY+'px';});
    overlay.addEventListener('pointerup', e=>{dragging=false; overlay.releasePointerCapture(e.pointerId);});

    overlay.addEventListener('touchstart', e=>{
      if(e.touches.length===2){
        e.preventDefault();
        const dx=e.touches[0].clientX - e.touches[1].clientX;
        const dy=e.touches[0].clientY - e.touches[1].clientY;
        startDistance = Math.sqrt(dx*dx+dy*dy);
        startScale = currentScale;
      }
    }, {passive:false});

    overlay.addEventListener('touchmove', e=>{
      if(e.touches.length===2){
        e.preventDefault();
        const dx=e.touches[0].clientX - e.touches[1].clientX;
        const dy=e.touches[0].clientY - e.touches[1].clientY;
        const newDist = Math.sqrt(dx*dx+dy*dy);
        const scale = newDist / startDistance;

        currentScale = Math.max(0.2, Math.min(5, startScale * scale));
        overlay.style.transform = `scale(${currentScale})`;

        overlaySizeInput.value = Math.round(overlay.naturalWidth * currentScale);
        overlaySizeVal.textContent = overlaySizeInput.value + "px";
      }
    }, {passive:false});

    downloadBtn.addEventListener('click', ()=> downloadMenu.style.display = downloadMenu.style.display==='flex'?'none':'flex');
    downloadMenu.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const scale = parseInt(btn.dataset.scale);
        html2canvas(canvas,{scale}).then(canvasOut=>{
          const link=document.createElement('a');
          link.download='text_image.png';
          link.href=canvasOut.toDataURL();
          link.click();
        });
        downloadMenu.style.display='none';
      });
    });

    // init
    updateDetectedWords();
    updateHighlightedText();
  </script>
</body>
</html>
